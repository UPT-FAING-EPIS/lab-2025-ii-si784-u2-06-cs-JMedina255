name: Release Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Semantic version (include matricula, e.g. 1.0.0-JMedina255)"
        required: false
        default: "1.0.0-JMedina255"

permissions:
  contents: write
  packages: write

env:
  PROJECT_FILE: UPTSiteTests/UPTSiteTests.csproj
  OUTPUT_DIR: artifacts

jobs:
  build-pack-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore $PROJECT_FILE

      - name: Pack NuGet
        run: dotnet pack $PROJECT_FILE -c Release -o $OUTPUT_DIR /p:PackageVersion=${{ github.event.inputs.version }}

      - name: Publish to GitHub Packages
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for pkg in $OUTPUT_DIR/*.nupkg; do
            dotnet nuget push "$pkg" \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --api-key "$NUGET_AUTH_TOKEN" \
              --skip-duplicate
          done

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Git Tag
        run: |
          VERSION=${{ github.event.inputs.version }}
          TAG="nuget-$VERSION"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nuget-${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: |
            - Paquete generado desde ${{ github.sha }}
            - Version incluida en el NuGet: ${{ github.event.inputs.version }}
          files: ${{ env.OUTPUT_DIR }}/*.nupkg
